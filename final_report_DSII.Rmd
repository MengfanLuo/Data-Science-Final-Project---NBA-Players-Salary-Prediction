---
title: "P8106 - Final Project - NBA Players Salary Prediction"
author: "Mingkuan Xu, Mengfan Luo, Yiqun Jin"
date: "5/9/2022"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,dpi=300)
library(tidyverse)
library(caret)
library(patchwork)
library(mgcv)
library(earth)
library(corrplot)
library(vip)
library(ggpubr)
library(ranger)
library(gbm)
library(factoextra)
library(lime)
```


## Introduction

For any team in the National Basketball Association (NBA), a key strategy to win more games is to properly allocate their salary cap - an agreement that places a limit on the amount of money that a team can spend on players' salaries. How to evaluate the performance of each NBA player and give a suitable level of salary is a therefore complicated problem.  In this project, we intend to predict the salary of NBA players in the 2021-2022 season based on their game statistics. We collected game statistics that are commonly used to evaluate players from the NBA official website, built both linear and non-linear models, including linear regression, ridge regression, lasso regression, GAM, MARS, ____________________, on selected feature variables, and compared these models to determine a final predictive model. 

## Data preprocessing

We will conduct data analysis and model construction based on two datasets on NBA players' contracted salary [1] and performance statistics per game [2] in 2021-2022. The following steps are included in our data preparation:

 - Two original datasets are inner joined by players and teams
 - Keep only one record with most number of games played for each of players, given a player may transfer to other teams during the session and have multiple records.
 - Remove 5 variables with missing values caused by division of other existing variables. 
 - Convert count variables (`field_goal`, `free_throw`, etc.) to rates by dividing variable `minute`

The final cleaned dataset has 442 records and 24 variables, including 2 categorical variables, 21 numerical variables and 1 numeric response variable `salary`.

- `position` -- Position of the player (5 categories)

- `age` -- Player's age on February 1 of the season

- `team` -- Team that the player belong to. (30 categories)

- `game` -- Number of games played per minute

- `game_starting` -- Number of games played as a starter per minute

- `minute` -- Minutes played per game

- `field_goal` -- Field goals per minute

- `fg_attempt` -- Field goal attempts per minute

- `x3p` -- 3-point field goals per minute

- `x3p_attempt` -- 3-point field goal attempts per minute

- `x2p` -- 2-point field goals per minute

- `x2p_attempt` -- 2-point field goal attempts per minute

- `free_throw` -- Free throws per minute

- `ft_attempt` -- Free throw attempts per minute

- `offensive_rb` -- Offensive rebounds per minute

- `defenssive_rb` -- Defensive rebounds per minute

- `total_rb` -- Total rebounds per minute

- `assistance` -- Assists per minute

- `steal` -- Steals per minute

- `block` -- Blocks per minute

- `turnover` -- Turnovers per minute

- `personal_foul` -- Personal fouls per minute

- `point` -- Points per minute

- `salary` -- Salary of the player in million


```{r joining datasets}
df_salary = read_csv("NBA_season2122_player_salary.csv") %>%
  janitor::clean_names() %>%
  select(Player=x2,Team=x3,Salary=salary_4) %>%
  na.omit()

df_salary = df_salary[-1,]

df_stats = read_csv("NBA_season2122_player_stats.csv") %>%
  rename(Team=Tm) %>%
  select(-Rk)

df_players = inner_join(x=df_salary,y=df_stats,by=c("Player","Team")) %>% 
  janitor::clean_names() %>% 
  distinct()

df_players = df_players %>% 
  arrange(player,desc(g)) %>% 
  distinct(player,.keep_all = TRUE)

# Removed variables with missing data and resulted from division of other variables
df_players = df_players %>% 
  select(-x3p_percent, -ft_percent, -fg_percent,-x2p_percent,-e_fg_percent)

# The final generated dataset for use: df_player.
```


```{r data cleaning}
# Convert salary from characters to numbers.
# Convert categorical variables to factors

df_players = df_players %>% 
  separate(salary,into = c("symbol", "salary"),1) %>% 
  select(-symbol)%>% 
  mutate(salary = as.numeric(salary)/1000000,
         team = factor(team),
         pos = factor(pos)) %>% 
  relocate(salary, .after = last_col())

colnames(df_players) = c("player", "team", "position", "age", "game","game_starting" ,"minute","field_goal", "fg_attempt", "x3p", "x3p_attempt" ,"x2p", "x2p_attempt",   "free_throw",   "ft_attempt", "offensive_rb", "defenssive_rb",  "total_rb" ,   "assistance" ,   "steal" , "block",    "turnover",  "personal_foul", "point", "salary")

df_players = df_players %>% 
  distinct(player,.keep_all = TRUE) %>%
  mutate(player = gsub("\\\\.*","",player)) %>%
  `row.names<-`(., NULL) %>% 
  column_to_rownames('player')

```

```{r}
## Since `minute` stands for minutes played per game, we will divided variables stands for counts by `minute` to get a rate. These variables includes `field_goal`, `fg_attempt`    `x3p`, `x3p_attempt`, `x2p`, `x2p_attempt`,   `free_throw`,  `ft_attempt`, `offensive_rb`  `defenssive_rb`, `total_rb`, `assistance`,`steal`, `block`, `turnover`, `personal_foul` and `point`.

df_players = df_players %>% 
  mutate(field_goal = field_goal/minute,
         fg_attempt = fg_attempt/minute,
         x3p = x3p/minute,
         x3p_attempt = x3p_attempt/minute,
         x2p = x2p/minute,
         x2p_attempt = x2p_attempt/minute,
         free_throw = free_throw/minute,
         ft_attempt = ft_attempt/minute,
         offensive_rb = offensive_rb/minute,
         defenssive_rb = defenssive_rb/minute,
         total_rb = total_rb/minute,
         assistance = assistance/minute,
         steal = steal/minute,
         block = block/minute,
         turnover = turnover/minute,
         personal_foul = personal_foul/minute,
         point = point/minute) 
```


## Exploratory Analysis 

### Univariate Analysis

The following plots show distribution of each univariable. For categorical variables `team` and `position`, they are dsitributed quite evenly. There are 30 unique values in `team`, which may result in too many dummy variables in the model. Therefore, we may consider exclude `team` or cluster it into fewer classes in selected models. 

```{r fig.height = 4}
par(mfrow=c(1,2))
plot_team = ggplot(df_players,mapping = aes(x = team)) + geom_bar(aes(team)) + 
 theme_bw()+
  theme(axis.text.x=element_blank())

plot_position = ggplot(df_players) + geom_bar(aes(position)) + theme_bw()
plot_team+plot_position
```

For numeric variables, some of them (`gs`, `ft`, `orb`,`blk`), including response `salary` are skewed, with some players have extremely high salary. Visualization for all variables are enclosed in Appendix A.

```{r dpi=300}
plot_data_column = function (data, column) {
    ggplot(data, aes_string(x = column)) +
        geom_histogram(bins=15) +
        xlab(column) + theme_bw(base_size = 10)
}

histograms <- lapply(colnames(df_players)[4:24], 
                       plot_data_column, data = df_players)

figure_a = ggarrange(plotlist = histograms[1:9], 
          ncol = 3, nrow = 3)

annotate_figure(figure_a, 
                top = text_grob("Histograms of Selected Variables (Group A)", 
                                face = "bold", size = 15))


figure_b = ggarrange(plotlist = histograms[10:18], 
          ncol = 3, nrow = 3)
annotate_figure(figure_b, 
                top = text_grob("Histograms of Predictive Variables (Group B)", 
                                face = "bold", size = 15))

figure_c = ggarrange(plotlist = histograms[19:21],
          ncol = 3, nrow = 3)
annotate_figure(figure_c, 
                top = text_grob("Histograms of Predictive Variables (Group C)", 
                                face = "bold", size = 15))
```



### Correlation Analysis

From the correlation heat map, it is obvious that multicolinearity could be a problem, which we may consider using penalized models (ridge, lasso) or ensembled models (random forest, boosting, neural network) to fix.

```{r}

df_corr_1 = df_players %>% 
  select(-team,-position)

corrplot(cor(df_corr_1),type = "lower")

```


### Analyzing trends in data

The feature maps demonstrated that some correlations are non-linear, which we may consider using GAM or MARS to address.

```{r, fig.height=4}
theme1 <- trellis.par.get()
theme1$plot.symbol$col <- rgb(0, 0, 0, 1) 
theme1$plot.symbol$pch <- 16
theme1$plot.line$col <- rgb(1, .1, .1, 1) 
theme1$plot.line$lwd <- 2 
theme1$strip.background$col <- rgb(.0, .2, .6, .2) 
trellis.par.set(theme1)

df_features = df_players[3:23]
featurePlot(x = df_features, 
            y = df_players$salary,
            plot = "scatter",
            # span = .5,
            labels = c("Predictors","Player Salary (Millions)"), 
            type = c("p", "smooth"), 
            layout = c(7, 3))
```

From categorical variable `position` and `team`, extremely high values and large variance in salary show in all positions and some teams.

```{r fig.height=4}

box1 = df_players %>% 
  mutate(
    pos = fct_reorder(position,salary)
  ) %>% 
  ggplot(aes(x = position, y = salary, group = pos, fill = pos))+
  geom_boxplot() + 
  theme_bw() +
  theme(legend.position="none")


box2 = df_players %>% 
  mutate(
    team = fct_reorder(team,salary)
  ) %>% 
  ggplot(aes(x = team, y = salary, group = team, fill = team))+
  geom_boxplot() + 
  theme_bw()+
  theme(legend.position="none",
        axis.text.x=element_blank())

box1 + box2

```


## Model Construction

* What predictor variables did you include?
* What technique did you use? What assumptions, if any, are being made by using this technique?
* If there were tuning parameters, how did you pick their values?
* Discuss the training/test performance if you have a test data set.
* Which variables play important roles in predicting the response?
* **Explain/visualize the final model you select.**
* What are the limitations of the models you used (if there are any)? Are the models flexible enough to capture the underlying truth?


```{r}
# Data partition
set.seed(8106)

indexTrain <- createDataPartition(y = df_players$salary, p = 0.75, list = FALSE, times = 1)
ctrl1 <- trainControl(method = "cv", number = 10)
```


## Conclusion

* What were your findings? Are they what you expect? What insights into the data can you make?


\newpage

## References

[1]https://www.basketball-reference.com/contracts/players.html

[2]https://www.basketball-reference.com/leagues/NBA_2022_per_game.html



\newpage

## Appendices

### Appendix A - Numeric Variable Distribution

```{r dpi=300}
plot_data_column = function (data, column) {
    ggplot(data, aes_string(x = column)) +
        geom_histogram(bins=15) +
        xlab(column) + theme_bw(base_size = 10)
}

histograms <- lapply(colnames(df_players)[4:24], 
                       plot_data_column, data = df_players)

figure_a = ggarrange(plotlist = histograms[1:9], 
          ncol = 3, nrow = 3)

annotate_figure(figure_a, 
                top = text_grob("Histograms of Predictive Variables (Group A)", 
                                face = "bold", size = 15))


figure_b = ggarrange(plotlist = histograms[10:18], 
          ncol = 3, nrow = 3)
annotate_figure(figure_b, 
                top = text_grob("Histograms of Predictive Variables (Group B)", 
                                face = "bold", size = 15))

figure_c = ggarrange(plotlist = histograms[19:21],
          ncol = 3, nrow = 3)
annotate_figure(figure_c, 
                top = text_grob("Histograms of Predictive Variables (Group C)", 
                                face = "bold", size = 15))
```

