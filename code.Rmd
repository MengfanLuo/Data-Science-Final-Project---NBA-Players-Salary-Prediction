---
title: "code"
author: "DS2"
date: "5/6/2022"
output: github_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(caret)
library(patchwork)
library(mgcv)
library(earth)
library(corrplot)
library(vip)
library(ggpubr)

```


## Introduction

NBA players are considered to be among the highest-paid athletes in the world. Despite even the minimum wage in the NBA is way higher than that of any professional league in North America, there's a large gap between NBA stars and ordinary players[1]. In this project, we are interested in finding the factors that influence salary of NBA players. We will also develop a model to predict the salary.

We will conduct data analysis and model construction based on two datasets on NBA players' contracted salary [2] and performance statistics per game [3] in 2021-2022. The following steps are included in our data preperation:

 - Two original datasets are inner joined by players and teams
 - Keep only one record with most number of games played for each of players, given a player may transfer to other teams during the session and have multiple records.
 - Remove 5 variables with missing values caused by division of other existing variables. 

The final cleaned dataset has 442 records and 24 variables. 

```{r joining datasets}
df_salary = read_csv("NBA_season2122_player_salary.csv") %>%
  janitor::clean_names() %>%
  select(Player=x2,Team=x3,Salary=salary_4) %>%
  na.omit()

df_salary = df_salary[-1,]

df_stats = read_csv("NBA_season2122_player_stats.csv") %>%
  rename(Team=Tm) %>%
  select(-Rk)

df_players = inner_join(x=df_salary,y=df_stats,by=c("Player","Team")) %>% 
  janitor::clean_names() %>% 
  distinct()

df_players = df_players %>% 
  arrange(player,desc(g)) %>% 
  distinct(player,.keep_all = TRUE)

# Removed variables with missing data and resulted from division of other variables
df_players = df_players %>% 
  select(-x3p_percent, -ft_percent, -fg_percent,-x2p_percent,-e_fg_percent)

#The final generated dataset for use: df_player.
```


```{r data cleaning}
# Convert salary from characters to numbers.
# Convert categorical variables to factors

df_players = df_players %>% 
  separate(salary,into = c("symbol", "salary"),1) %>% 
  select(-symbol)%>% 
  mutate(salary = as.numeric(salary)/1000000,
         team = factor(team),
         pos = factor(pos)) %>% 
  relocate(salary, .after = last_col())

colnames(df_players) = c("player", "team", "position", "age", "game","game_starting" ,"minute","field_goal", "fg_attempt", "x3p", "x3p_attempt" ,"x2p", "x2p_attempt",   "free_throw",   "ft_attempt", "offensive_rb", "defenssive_rb",  "total_rb" ,   "assistance" ,   "steal" , "block",    "turnover",  "personal_foul", "point", "salary")

```


\newpage

### Univariate analysis

The following plots show distribution of each univariable. For categorical variables `team` and `pos`, they are dsitributed quite evenly. There are 30 unique values in `team` and 5 in `pos`. We may consider remove `team` for it may result in too many dummy variables in the model.

```{r fig.height = 3}
par(mfrow=c(1,2))
plot(df_players$team, main = "team")
plot(df_players$position, main = "position")
```

For numeric variables, some of them (`gs`, `ft`, `orb`,`blk`), including response `salary` are skewed, with some players have extremely high salary. Visualization for all variables are enclosed in Appendix B


```{r fig.height = 4}

df_appendix_b = df_players

par(mfrow=c(2,3))
hist(df_players$game_starting)
hist(df_players$free_throw)
hist(df_players$offensive_rb)
hist(df_players$block)
hist(df_players$salary)
```


### Appendix B - Variable Distribution

```{r fig.height = 6}
par(mfrow=c(3,3))
hist(df_appendix_b$age,main = "age")
hist(df_appendix_b$game,main = "game")
hist(df_appendix_b$game_starting,main = "game_starting")
hist(df_appendix_b$minute,main = "minute")
hist(df_appendix_b$field_goal,main = "field_goal")
hist(df_appendix_b$fg_attempt,main = "fg_attempt")
hist(df_appendix_b$x3p,main = "x3p")
hist(df_appendix_b$x3p_attempt,main = "x3p_attempt")
hist(df_appendix_b$x2p,main = "x2p")
#mtext("Distribution of numeric Variables",side = 3)
```

```{r fig.height = 6}
par(mfrow=c(3,3))
hist(df_appendix_b$age,main = "age")
hist(df_appendix_b$game,main = "game")
hist(df_appendix_b$game_starting,main = "game_starting")
hist(df_appendix_b$minute,main = "minute")
hist(df_appendix_b$field_goal,main = "field_goal")
hist(df_appendix_b$fg_attempt,main = "fg_attempt")
hist(df_appendix_b$x3p,main = "x3p")
hist(df_appendix_b$x3p_attempt,main = "x3p_attempt")
hist(df_appendix_b$x2p,main = "x2p")
#mtext("Distribution of numeric Variables",side = 3)
```


```{r dpi=300}
plot_data_column = function (data, column) {
    ggplot(data, aes_string(x = column)) +
        geom_histogram(bins=15) +
        xlab(column) + theme_bw(base_size = 10)
}

histograms_a <- lapply(colnames(df_players)[4:12], 
                       plot_data_column, data = df_players)
figure_a = ggarrange(plotlist = histograms_a, 
          ncol = 3, nrow = 3)
annotate_figure(figure_a, 
                top = text_grob("Histograms of Predictive Variables (Group A)", 
                                face = "bold", size = 15))
```

```{r dpi=300}

histograms_b <- lapply(colnames(df_players)[13:21], 
                       plot_data_column, data = df_players)
figure_b = ggarrange(plotlist = histograms_b, 
          ncol = 3, nrow = 3)
annotate_figure(figure_b, 
                top = text_grob("Histograms of Predictive Variables (Group B)", 
                                face = "bold", size = 15))
```
```{r dpi=300}

histograms_c <- lapply(colnames(df_players)[22:24], 
                       plot_data_column, data = df_players)
figure_c = ggarrange(plotlist = histograms_c, 
          ncol = 3, nrow = 3)
annotate_figure(figure_c, 
                top = text_grob("Histograms of Predictive Variables (Group C)", 
                                face = "bold", size = 15))
```


```{r fig.height = 2}
par(mfrow=c(1,3))
hist(df_appendix_b$turnover,main = "turnover")
hist(df_appendix_b$personal_foul,main = "personal foul")
hist(df_appendix_b$point,main = "point")
```


```{r}
hist(df_appendix_b$salary,main = "salary")
```

\newpage

### Correlation Analysis

```{r}

df_corr_1 = df_players %>% 
  select(-player, -team,-position)

corrplot(cor(df_corr_1),type = "lower")

```


\newpage

### Analyzing trends in data

From numeric variables, we found that `stl`,`x3p`, `age`,`gs` seem to have some non-linear trends.

```{r, fig.height=4}
theme1 <- trellis.par.get()
theme1$plot.symbol$col <- rgb(.2, .4, .2, .5)
theme1$plot.symbol$pch <- 16
theme1$plot.line$col <- rgb(.8, .1, .1, 1)
theme1$plot.line$lwd <- 2
theme1$strip.background$col <- rgb(.0, .2, .6, .2)
trellis.par.set(theme1)

featurePlot(df_players[4:24], df_players$salary, plot = "scatter", labels = c("","Y"),
            type = c("p"), layout = c(5,2))
```

From categorical variable `position`, extremely high values in salary show in all positions and some teams.

```{r fig.height=4}
df_players %>% 
  mutate(
    pos = fct_reorder(position,salary)
  ) %>% 
  ggplot(aes(x = position, y = salary, group = pos, fill = pos))+
  geom_boxplot()

```


